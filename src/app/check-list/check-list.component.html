<div class="container">
  <h2>{{ 'PLAYER_DETAIL.TITLE' | translate }}</h2>
  <div class="card-form">

    <p class="text-muted mb-4">{{ 'PLAYER_DETAIL.DESCRIPTION' | translate }}</p>

    <div class="form-row">
      <div class="form-group">
        <label>{{ 'PLAYER_DETAIL.ROLE_LABEL' | translate }}</label>
        <select [(ngModel)]="selectedRole" (change)="onRoleChange()" class="role-select">
          <option *ngFor="let r of roleOptions" [value]="r.value">
            {{ r.label | translate }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>{{ 'PLAYER_DETAIL.TARGET_TEAM_LABEL' | translate }}</label>
        <select [(ngModel)]="selectedTarget" (change)="onRoleChange()">
          <option *ngFor="let t of targetOptions" [value]="t">{{ t }}</option>
        </select>
      </div>

      <div class="form-group">
        <label>{{ 'PLAYER_DETAIL.VARIANT_LABEL' | translate }}</label>
        <select [(ngModel)]="selectedVariant" (change)="onRoleChange()">
          <option *ngFor="let v of variantOptions" [value]="v">{{ v }}</option>
        </select>
      </div>
    </div>

    <div class="form-row" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
      <div class="form-group" style="flex: 1;">
        <label>{{ 'PLAYER_DETAIL.SELECT_LIST_LABEL' | translate }}</label>
        <select [(ngModel)]="selectedListId" (change)="onListChange()" class="list-select">
          <option value="">-- {{ 'PLAYER_DETAIL.CSV_FILE_LABEL' | translate }} --</option>
          <optgroup *ngFor="let group of groupedLists | keyvalue" [label]="group.key">
            <option *ngFor="let list of group.value" [value]="list.id">
              {{ list.name }}
            </option>
          </optgroup>
        </select>
      </div>

      <div class="form-group" style="flex: 1;">
        <label>{{ 'PLAYER_DETAIL.CSV_FILE_LABEL' | translate }}</label>
        <input type="file" (change)="onFileSelected($event)" accept=".csv" class="file-input" />
      </div>
    </div>
  </div>

  <div class="results-section" *ngIf="playerResults.length > 0">
    <p><br></p>
    <h4>
      {{ 'PLAYER_DETAIL.ANALYSIS_TITLE' | translate }}
      <span style="color:#007bff">{{ selectedRole | uppercase }}</span>
    </h4>

    <div class="mdc-data-table" data-mdc-auto-init="MDCDataTable">
      <table class="mdc-data-table__table">
        <thead>
          <tr class="mdc-data-table__header-row">
            <th class="mdc-data-table__header-cell" style="width: 10%">{{ 'PLAYER_DETAIL.PLAYER_COLUMN' | translate }}
            </th>
            <th class="mdc-data-table__header-cell" style="width: 5%">{{ 'PLAYER_DETAIL.MARKET_COLUMN' | translate }}
            </th>
            <th class="mdc-data-table__header-cell" style="width: 5%">{{ 'PLAYER_DETAIL.AGE_COLUMN' | translate }}</th>
            <th class="mdc-data-table__header-cell" style="width: 10%">{{ 'PLAYER_DETAIL.TARGET_STATUS_COLUMN' |
              translate }}</th>
            <th class="mdc-data-table__header-cell" style="width: 20%">{{ 'PLAYER_DETAIL.SKILLS_STATUS_COLUMN' |
              translate }}</th>
            <th class="mdc-data-table__header-cell" style="width: 25%">{{ 'PLAYER_DETAIL.TRAINING_CHECK_COLUMN' |
              translate }}</th>
            <th class="mdc-data-table__header-cell" style="width: 5%">{{ 'PLAYER_DETAIL.STAFF_CHECK_COLUMN' | translate
              }}</th>
            <th class="mdc-data-table__header-cell" style="width: 10%">{{ 'PLAYER_DETAIL.SCOUT_NOTE_COLUMN' | translate
              }}</th>
          </tr>
        </thead>
        <tbody class="mdc-data-table__content">
          <tr *ngFor="let p of playerResults" [class]="'row-' + p.status + ' mdc-data-table__row'">
            <td class="mdc-data-table__cell">
              <small>
                {{ p.fullName }} <br>
                <strong>
                  <a href="https://hattrickportal.online/Tracker/Player.aspx?playerID={{ p.id }}"
                    target="_portal{{ p.id }}">
                    {{ 'MANAGE_PLAYER.PORTAL_LINK' | translate }}
                  </a>
                  <br>
                  <a href="https://www.hattrick.org/goto.ashx?path=/MyHattrick/Inbox/?actionType=newMail%26userid={{ p.owningUserID }}"
                    target="_portal{{ p.owningUserID }}">
                    HT Mail
                  </a>
                </strong>
              </small>
            </td>

            <td class="mdc-data-table__cell">
              <small>
                <div *ngIf="p.transferListed">
                  <div *ngIf="p.transferListed === '0'" style="color: #28a745; font-size: 0.85em;">‚úÖ</div>
                  <div *ngIf="p.transferListed === '1'" style="color: #d9534f; font-weight: bold;">
                    {{ 'PLAYER_DETAIL.MARKET_AVAILABLE' | translate }}
                  </div>
                </div>
              </small>
            </td>

            <td class="mdc-data-table__cell"><small>{{ p.age }}.{{ p.ageDays }}</small></td>

            <td class="mdc-data-table__cell">
              <div *ngIf="p.status === 'LOADING'">{{ 'PLAYER_DETAIL.LOADING_ANALYSIS' | translate }}</div>
              <div *ngIf="p.analysis">
                <span class="badge" [class.success]="p.analysis['4_role_targets'].status === 'COMPLETED'"
                  [class.warning]="p.analysis['4_role_targets'].status === 'IN_PROGRESS'">
                  {{ p.analysis['4_role_targets'].status }}
                </span>
                <br>
                <small style="color: #666;">
                  {{ p.analysis['4_role_targets'].role_analyzed }}
                </small>
              </div>
              <div *ngIf="p.error" class="error-text">‚ùå {{ p.error }}</div>
            </td>

            <td class="mdc-data-table__cell" style="vertical-align: top;">
              <div *ngIf="p.analysis; else waitingAnalysis">
                <div *ngFor="let detail of p.analysis['4_role_targets'].details"
                  style="margin-bottom: 4px; font-size: 0.9em; display: flex; align-items: center;">

                  <span style="margin-right: 6px;">
                    <ng-container *ngIf="detail.status === 'OK'">‚úÖ</ng-container>
                    <ng-container *ngIf="detail.status !== 'OK'">{{ 'PLAYER_DETAIL.WARNING_STATUS' | translate
                      }}</ng-container>
                  </span>

                  <span style="font-weight: bold; width: 90px; text-transform: capitalize;"
                    [style.color]="detail.status === 'OK' ? '#28a745' : '#d9534f'">
                    {{ detail.skill }}:
                  </span>

                  <span style="font-family: monospace; font-size: 1.1em;">
                    <strong [style.color]="detail.status === 'OK' ? '#333' : '#d9534f'">
                      {{ detail.current }}
                    </strong>
                    <span style="color: #999;"> / {{ detail.target }}</span>
                  </span>

                  <span *ngIf="detail.status !== 'OK'"
                    style="margin-left: 8px; font-size: 0.8em; color: #d9534f; background: #ffeeee; padding: 0 4px; border-radius: 4px;">
                    {{ (detail.current - detail.target) | number:'1.0-1' }}
                  </span>
                </div>
                <div *ngIf="p.analysis['4_role_targets'].details.length === 0" style="color:#666; font-style:italic">
                  {{ 'PLAYER_DETAIL.NO_SPECIFIC_TARGET' | translate }}
                </div>
              </div>
              <ng-template #waitingAnalysis>
                <span style="color: #ccc;">-</span>
              </ng-template>
            </td>

            <td class="mdc-data-table__cell" style="font-size: 0.9em; vertical-align: top;">
              <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee;">
                <div style="color: #555;">üìÖ <strong>{{ p.lastUpdate }}</strong></div>

                <div *ngIf="p.analysis">
                  <div *ngIf="p.analysis['1_freshness']?.status === 'OK'" style="color: #28a745; font-size: 0.85em;">
                    {{ 'PLAYER_DETAIL.RECENT_DATA' | translate }}
                  </div>
                  <div *ngIf="p.analysis['1_freshness']?.status !== 'OK'" style="color: #d9534f; font-weight: bold;">
                    ‚ùå {{ p.analysis['1_freshness']?.message }}
                  </div>
                </div>
              </div>

              <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee;">
                <div>üèãÔ∏è <strong>{{ p.trainingType }}</strong></div>
                <div>üîã <strong>{{ p.stamina }}%</strong> {{ 'MY_PLAYERS.STAMINA_LABEL' | translate }}</div>
              </div>

              <div *ngIf="p.analysis">
                <div *ngIf="p.analysis['3_compatibility']?.status !== 'OK'" style="color: #d9534f; margin-bottom: 5px;">
                  ‚õî {{ p.analysis['3_compatibility']?.message }}
                </div>

                <div *ngIf="p.analysis['5_stamina'].status === 'WARNING'" style="color: #d9534f;">
                  ‚ö†Ô∏è {{ p.analysis['5_stamina'].message }}
                </div>
              </div>
            </td>

            <td class="mdc-data-table__cell">
              <small>
                <div *ngIf="p.teamTrainerSkill">
                  <div *ngIf="p.teamTrainerSkill > '6'" style="color: #28a745; font-size: 0.85em;">
                    ‚úÖ: {{ p.teamTrainerSkill}}
                  </div>
                  <div *ngIf="p.teamTrainerSkill <= '6'" style="color: #d9534f; font-weight: bold;">
                    {{ 'PLAYER_DETAIL.STAFF_INADEQUATE' | translate }}: {{ p.teamTrainerSkill}}
                  </div>
                </div>
              </small>
            </td>

            <td class="mdc-data-table__cell"><small>{{ p.lastScoutNote }}</small></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>